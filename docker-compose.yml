# This is example of docker-compose file
# which can be used to run NexentaFusion ecosystem.
# 
# Please note, that following settings provide
# password protected Elasticsearch (also with SSL enabled)
# Check elasticsearch environment settings:
#   AUTH_USERNAME
#   AUTH_PASSWORD
#
# Make sure your docker host machine vm.max_map_count kernel setting value is at least 262144. 
# It is necessary for the Elasticsearch container. 
# Here is an instruction how to get and set this kernel setting 
# https://www.elastic.co/guide/en/elasticsearch/reference/7.2/docker.html#docker-cli-run-prod-mode
#
# Usage:
#   docker-compose up -d

version: '3.2'

services:
  fusion:
    image: nexenta/fusion-dev:${VERSION:-2.0.0.3}
    container_name: fusion
    restart: always
    environment:
    # If you want NexentaFusion to listen on other port than 8457
    # change environment variable below and do a change in the ports section 
    # or just use PORT environment variable to specify port
    #
    # Example: PORT=443 docker-compose up -d 
      PORT: ${PORT:-8457}
    # If you want to specify management address and Elasticsearch info,
    # then uncomment following lines.
    # Note: If settings are defined as environment variables, then
    # they would be displayed as read-only in UI configuration screens.
    #   MANAGEMENT_ADDRESS: "192.168.10.62"
    #   ELASTICSEARCH_SERVERS: 'https://admin:elasticsearch@192.168.10.62:9200'
    #
    # Timezone of container. Default: UTC+0
      TZ: ${TZ:-Etc/UTC}
    # Proxy server address
      WEB_PROXY: ${WEB_PROXY}
    volumes:
      - fusion-data:/var/lib/nef
    ports:
      - ${PORT:-8457}:8457

  elasticsearch:
    image: nexenta/fusion-elasticsearch:7.2.0.0
    container_name: fusion-elasticsearch
    restart: always
    environment:
      # Credentials for remote elasticsearch access
      AUTH_USERNAME: ${ESDB_USERNAME:-admin}
      AUTH_PASSWORD: ${ESDB_PASSWORD:-elasticsearch}

      HOSTNAME: "elasticsearch"
      bootstrap.memory_lock: "true"
      discovery.type: single-node
      # Specify heap size. It should be a half of memory dedicated to container (maximum is 31g)
      # Example: Total memory provided to container is 4g. Heap size should be set to 2g:
      #     "-Xms2g -Xmx2g"
      # Performance note: If heap size is set to value larger than half of RAM, you may experience
      # a slowdown of database
      ES_JAVA_OPTS: "-Xms${ESDB_HEAP_SIZE:-1g} -Xmx${ESDB_HEAP_SIZE:-1g}"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - fusion-elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - 9200:9200

volumes:
  fusion-data:
    driver: local
  fusion-elasticsearch-data:
    driver: local
